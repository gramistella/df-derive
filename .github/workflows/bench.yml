# .github/workflows/bench.yml

name: Run Benchmarks

# Controls when the action will run.
on:
  workflow_call:
    inputs:
      event_name:
        required: true
        type: string
      ref:
        required: true
        type: string

# Avoid overlapping benchmark runs on the same ref.
concurrency:
  group: benchmark-${{ github.ref }}
  cancel-in-progress: true

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  benchmark:
    name: Run and Compare Benchmarks
    runs-on: ubuntu-22.04

    env:
      CARGO_INCREMENTAL: '0'
      # Force consistent, optimized builds on CI
      RUSTFLAGS: "-C target-cpu=native -C codegen-units=1 -C opt-level=3 -C lto=thin"
      # Pin parallelism for determinism
      RAYON_NUM_THREADS: '1'
      POLARS_MAX_THREADS: '1'
      CARGO_TERM_COLOR: always

    # Set permissions for GitHub token.
    # Required for deploying to GitHub Pages and for bencher/gha-adapter to comment on PRs.
    permissions:
      pages: write
      id-token: write
      contents: read
      pull-requests: write
      checks: write

    steps:
      # 1. Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch the main branch to compare against.
          # Set fetch-depth to 0 to fetch all history for all branches and tags.
          fetch-depth: 0

      # 2. Set up Rust toolchain and cache dependencies
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo dependencies
        uses: Swatinem/rust-cache@v2

      # 3. Install Bencher CLI
      - name: Install Bencher CLI
        uses: bencherdev/bencher@main

      # 4. Run benchmarks and track with Bencher
      # This command runs benchmarks and sends results to Bencher for tracking
      - name: Track base branch benchmarks with Bencher
        run: |
          CRITERION_FLAGS="--sample-size 150 --warm-up-time 8 --measurement-time 20 --nresamples 200000 --noise-threshold 0.02 --confidence-level 0.99"
          bencher run \
          --project df-derive \
          --token '${{ secrets.BENCHER_API_TOKEN }}' \
          --branch "${{ github.ref_name }}" \
          --testbed ubuntu-22.04 \
          --threshold-measure latency \
          --threshold-test t_test \
          --threshold-max-sample-size 64 \
          --threshold-upper-boundary 0.99 \
          --thresholds-reset \
          --err \
          --adapter rust_criterion \
          --github-actions '${{ secrets.GITHUB_TOKEN }}' \
          "taskset -c 0 cargo bench -- ${CRITERION_FLAGS}"

      # 5. Upload the HTML report as an artifact (only on `main` branch)
      # This prepares the report for deployment to GitHub Pages.
      - name: Upload Pages artifact
        if: inputs.event_name == 'push' && inputs.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          # The folder where the HTML report is generated.
          path: ./target/criterion/

      # 6. Deploy the report to GitHub Pages (only on `main` branch)
      - name: Deploy to GitHub Pages
        if: inputs.event_name == 'push' && inputs.ref == 'refs/heads/main'
        id: deployment
        uses: actions/deploy-pages@v4